<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    
    <title>分析问题 | 贺龙飞的知识库</title>
    
    
        <meta name="keywords" content="mysql">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="基本认识 要学会怎样分析问题，而不是单纯拍脑袋优化 慢查询只是最基础的东西，要学会优化0.01秒的查询请求。 当发生连接阻塞时，不同状态的阻塞有不同的原因，要找到原因，如果不对症下药，就会南辕北辙 范例：如果本身系统内存已经超载，已经使用到了swap，而还在考虑加大缓存来优化查询，那就是自寻死路了。   影响结果集是非常重要的中间数据和优化指标，学会理解这一概念，理论上影响结果集与查询效率呈现非常">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="分析问题">
<meta property="og:url" content="http://yoursite.com/2-开发技能/数据库/Mysql/分析问题/index.html">
<meta property="og:site_name" content="贺龙飞的知识库">
<meta property="og:description" content="基本认识 要学会怎样分析问题，而不是单纯拍脑袋优化 慢查询只是最基础的东西，要学会优化0.01秒的查询请求。 当发生连接阻塞时，不同状态的阻塞有不同的原因，要找到原因，如果不对症下药，就会南辕北辙 范例：如果本身系统内存已经超载，已经使用到了swap，而还在考虑加大缓存来优化查询，那就是自寻死路了。   影响结果集是非常重要的中间数据和优化指标，学会理解这一概念，理论上影响结果集与查询效率呈现非常">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-03T16:04:44.529Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="分析问题">
<meta name="twitter:description" content="基本认识 要学会怎样分析问题，而不是单纯拍脑袋优化 慢查询只是最基础的东西，要学会优化0.01秒的查询请求。 当发生连接阻塞时，不同状态的阻塞有不同的原因，要找到原因，如果不对症下药，就会南辕北辙 范例：如果本身系统内存已经超载，已经使用到了swap，而还在考虑加大缓存来优化查询，那就是自寻死路了。   影响结果集是非常重要的中间数据和优化指标，学会理解这一概念，理论上影响结果集与查询效率呈现非常">
    

    
        <link rel="alternate" href="/atom.xml" title="贺龙飞的知识库" type="application/atom+xml">
    

    
        <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>
</html>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">贺龙飞的知识库</span>
            </a>
            <nav id="main-nav">
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>分类</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            1-基础知识
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            计算机网络
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/1-基础知识/计算机网络/网络参考模型/">网络参考模型</a></li>  <li class="file"><a href="/1-基础知识/计算机网络/tcp-ip-协议/">TCP/IP 协议</a></li>  <li class="file"><a href="/1-基础知识/计算机网络/http-协议/">Http 协议</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            2-开发技能
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            GIT
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/GIT/git/">Git 常用命令</a></li>  <li class="file"><a href="/2-开发技能/GIT/git-flow/">GitFlow</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            安全
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/安全/Web攻击手段/">WEB 攻击手段</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            数据库
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            Mysql
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/数据库/Mysql/基础知识/">基础知识</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/架构与表设计/"> 架构与表设计</a></li>  <li class="file active"><a href="/2-开发技能/数据库/Mysql/分析问题/">分析问题</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/性能优化/">性能优化</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/运维指南/">运维指南</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/常见错误/">常见错误</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/常用Sql/">常用SQL</a></li>  <li class="file"><a href="/2-开发技能/数据库/Mysql/常用函数/">常用函数</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            权限控制
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/权限控制/rbac/">RBAC</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            测试
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/测试/codeception/">Codeception 之验收测试</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            程序语言
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            PHP
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            框架
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/程序语言/PHP/框架/lumen项目初始化/">Lumen项目初始化</a></li>  <li class="file"><a href="/2-开发技能/程序语言/PHP/框架/laravel项目初始化/">Laravel项目初始化</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/2-开发技能/程序语言/PHP/yar/">YAR</a></li>  <li class="file"><a href="/2-开发技能/程序语言/PHP/php-psr/">PSR</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            面向对象
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2-开发技能/面向对象/uml/">UML</a></li>  <li class="file"><a href="/2-开发技能/面向对象/oo-principle/">设计原则</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            3-架构设计
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            中间件
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            MQ
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/3-架构设计/中间件/MQ/activemq/">ActiveMQ</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            架构设计
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/3-架构设计/架构设计/web-servive/">Web Servive</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            4-开源软件
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/4-开源软件/blog/">Blog 系统之 Hexo</a></li>  <li class="file"><a href="/4-开源软件/atom/">Atom 编辑器</a></li>  <li class="file"><a href="/4-开源软件/wiki/">Wiki 系统之 Simiki</a></li>  <li class="file"><a href="/4-开源软件/pandoc/">Pandoc</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            5-效率工具
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/5-效率工具/mac/">MAC 必备软件</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/index/">欢迎来到贺龙飞的知识库！</a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-2-开发技能/数据库/Mysql/分析问题" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/2-开发技能/">2-开发技能</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/2-开发技能/数据库/">数据库</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/2-开发技能/数据库/Mysql/">Mysql</a>
    </div>

                        
                            <div class="article-meta-button">
                                <a href="https://github.com/hlf513/wiki/commits/master/source/_posts/2-开发技能/数据库/Mysql/分析问题.md" rel="external nofollow noopener noreferrer" target="_blank"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            分析问题
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">文章目录</strong>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基本认识"><span class="toc-text">基本认识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#常见关注的重点"><span class="toc-text">常见关注的重点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#慢查询日志"><span class="toc-text">慢查询日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Explain-操作"><span class="toc-text">Explain 操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set-profiling-show-profiles-for-query操作"><span class="toc-text">Set profiling , show profiles for query操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Show-processlist-执行状态监控"><span class="toc-text">Show processlist 执行状态监控</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#排查步骤"><span class="toc-text">排查步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#确认问题"><span class="toc-text">确认问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#确认瓶颈"><span class="toc-text">确认瓶颈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#了解基本运营状况"><span class="toc-text">了解基本运营状况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#了解基本负载情况"><span class="toc-text">了解基本负载情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看-mysql-的状态"><span class="toc-text">查看 mysql 的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#频繁度分析"><span class="toc-text">频繁度分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制定方案"><span class="toc-text">制定方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试方案"><span class="toc-text">测试方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实施方案"><span class="toc-text">实施方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#回顾反馈"><span class="toc-text">回顾反馈</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#案例分析"><span class="toc-text">案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器出现too-many-connections-阻塞"><span class="toc-text">服务器出现too many connections 阻塞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库负载过高，响应缓慢"><span class="toc-text">数据库负载过高，响应缓慢</span></a></li></ol></li></ol>
                </div>
            
        
        
            <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="基本认识"><a href="#基本认识" class="headerlink" title="基本认识"></a>基本认识</h1><ul>
<li>要学会怎样分析问题，而不是单纯拍脑袋优化</li>
<li>慢查询只是最基础的东西，要学会优化0.01秒的查询请求。</li>
<li>当发生连接阻塞时，不同状态的阻塞有不同的原因，要找到原因，如果不对症下药，就会南辕北辙<ul>
<li>范例：如果本身系统内存已经超载，已经使用到了swap，而还在考虑加大缓存来优化查询，那就是自寻死路了。</li>
</ul>
</li>
<li>影响结果集是非常重要的中间数据和优化指标，学会理解这一概念，理论上影响结果集与查询效率呈现非常紧密的线性相关。</li>
<li>监测与跟踪要经常做，而不是出问题才做<ul>
<li>读取频繁度抽样监测<ul>
<li>全监测不要搞，i/o吓死人。</li>
<li>按照一个抽样比例抽样即可。</li>
<li>针对抽样中发现的问题，可以按照特定SQL在特定时间内监测一段全查询记录，但仍要考虑i/o影响。</li>
</ul>
</li>
<li>写入频繁度监测<ul>
<li>基于binlog解开即可，可定时或不定时分析。</li>
</ul>
</li>
<li>微慢查询抽样监测<ul>
<li>高并发情况下，查询请求时间超过0.01秒甚至0.005秒的，建议酌情抽样记录。</li>
</ul>
</li>
<li>连接数预警监测<ul>
<li>连接数超过特定阈值的情况下，虽然数据库没有崩溃，建议记录相关连接状态。</li>
</ul>
</li>
</ul>
</li>
<li>学会通过数据和监控发现问题，分析问题，而后解决问题顺理成章。特别是要学会在日常监控中发现隐患，而不是问题爆发了才去处理和解决。</li>
</ul>
<h1 id="常见关注的重点"><a href="#常见关注的重点" class="headerlink" title="常见关注的重点"></a>常见关注的重点</h1><h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><ul>
<li><p>是否锁定，及锁定时间<br>如存在锁定，则该慢查询通常是因锁定因素导致，本身无需优化，需解决锁定问题。</p>
</li>
<li><p>影响结果集<br>如影响结果集较大，显然是索引项命中存在问题，需要认真对待。</p>
</li>
</ul>
<h2 id="Explain-操作"><a href="#Explain-操作" class="headerlink" title="Explain 操作"></a>Explain 操作</h2><ul>
<li><p>索引项使用<br>不建议用using index做强制索引，如未如预期使用索引，建议重新斟酌表结构和索引设置。</p>
</li>
<li><p>影响结果集<br>这里显示的数字不一定准确，结合之前提到对数据索引的理解来看，还记得嘛？就把索引当作有序序列来理解，反思SQL。</p>
</li>
</ul>
<h2 id="Set-profiling-show-profiles-for-query操作"><a href="#Set-profiling-show-profiles-for-query操作" class="headerlink" title="Set profiling , show profiles for query操作"></a>Set profiling , show profiles for query操作</h2><ul>
<li>执行开销<ul>
<li>注意，有问题的SQL如果重复执行，可能在缓存里，这时要注意避免缓存影响。通过这里可以看到。</li>
<li>执行时间超过0.005秒的频繁操作SQL建议都分析一下。</li>
<li>深入理解数据库执行的过程和开销的分布</li>
</ul>
</li>
</ul>
<h2 id="Show-processlist-执行状态监控"><a href="#Show-processlist-执行状态监控" class="headerlink" title="Show processlist 执行状态监控"></a>Show processlist 执行状态监控</h2><p>这是在数据库负载波动时经常进行的一项操作<br>具体参见：<a href="/技术之路/数据库/Mysql/优化/#执行状态">查看执行状态</a></p>
<h1 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h1><h2 id="确认问题"><a href="#确认问题" class="headerlink" title="确认问题"></a>确认问题</h2><p><strong>详细了解问题状况</strong></p>
<ul>
<li>Too many connections 是常见表象，有很多种原因。</li>
<li>索引损坏的情况在innodb情况下很少出现。</li>
<li>如出现其他情况应追溯日志和错误信息。</li>
</ul>
<h2 id="确认瓶颈"><a href="#确认瓶颈" class="headerlink" title="确认瓶颈"></a>确认瓶颈</h2><p><strong>常见的瓶颈</strong></p>
<ul>
<li><p>cpu 非常高–索引问题 or 并发太高（通常是索引问题）<br>并发问题：thread_pool 限制连接数（其他分支都支持线程池）</p>
</li>
<li><p>内存 swap高 – 内存分配不足（过多会 oom）<br>适量调整内存，不要太大也不要太小，50%-70%比较保守，80%太偏激，尽量覆盖全部热点数据<br>mysql 专用服务器，关闭 swap</p>
</li>
<li><p>iowait 太高 – 内存不足 or io 设备性能太低 or 索引不当 or 频繁读取 select  or 频繁排序/分组</p>
</li>
</ul>
<h3 id="了解基本运营状况"><a href="#了解基本运营状况" class="headerlink" title="了解基本运营状况"></a>了解基本运营状况</h3><ul>
<li>当前每秒读请求</li>
<li>当前每秒写请求</li>
<li>当前在线用户</li>
<li>当前数据容量</li>
</ul>
<h3 id="了解基本负载情况"><a href="#了解基本负载情况" class="headerlink" title="了解基本负载情况"></a>了解基本负载情况</h3><p>学会使用这些指令</p>
<ul>
<li>Top –系统状态，哪个服务/进程消耗的 cpu 、内存</li>
<li>Vmstat – 查看 cpu、io、内存负载</li>
<li>dstat – 和 vmstat 类似，结果更友好</li>
<li>sar – systat 工具包的一个命令；关注（sar  -u / -d / -r）cpu/io/内存</li>
<li>iotop – 查看哪个进程 io 消耗最高</li>
<li>oprofile – 神器，一般用不上，用法自己查</li>
<li>strace – 跟踪进程执行时的系统调用和所接收的信号</li>
<li>uptime</li>
<li>iostat</li>
<li>df</li>
</ul>
<p>Cpu负载构成</p>
<ul>
<li>特别关注i/o压力( wa%)</li>
<li>多核负载分配</li>
</ul>
<p>内存占用</p>
<ul>
<li>Swap分区是否被侵占，若Swap分区被侵占，物理内存是否较多空闲</li>
</ul>
<p>磁盘状态</p>
<ul>
<li>硬盘满和inode节点满的情况要迅速定位和迅速处理</li>
</ul>
<h3 id="查看-mysql-的状态"><a href="#查看-mysql-的状态" class="headerlink" title="查看 mysql 的状态"></a>查看 mysql 的状态</h3><p><strong>当前连接数</strong></p>
<ul>
<li>Netstat –an|grep 3306|wc –l</li>
<li>Show processlist</li>
</ul>
<p><strong>当前连接分布 show processlist</strong></p>
<ul>
<li>前端应用请求数据库不要使用root帐号！<ul>
<li>Root帐号比其他普通帐号多一个连接数许可。</li>
<li>前端使用普通帐号，在too many connections的时候root帐号仍可以登录数据库查询 show processlist!</li>
<li>记住，前端应用程序不要设置一个不叫root的root帐号来糊弄！非root账户是骨子里的，而不是名义上的。</li>
</ul>
</li>
<li>状态分布<ul>
<li>不同状态代表不同的问题，有不同的优化目标。</li>
</ul>
</li>
<li>雷同SQL的分布<ul>
<li>是否较多雷同SQL出现在同一状态</li>
</ul>
</li>
</ul>
<p><strong>当前是否有较多慢查询日志</strong></p>
<ul>
<li>是否锁定</li>
<li>影响结果集</li>
</ul>
<p><strong>常用命令</strong></p>
<ul>
<li><p>slow log<br>优先频次高，其次耗时久</p>
</li>
<li><p>show global status</p>
<ol>
<li>查看连接数（活跃、不活跃），设置 interactive_timeout、wait_timeout 的 timecount值，减少不活跃连接</li>
<li>TPS、QPS、DML_Active<ul>
<li>tps=(handler_commit_d+handler_rollback_d)/uptime_d</li>
<li>qps=(questions_d2 - questions_d1)/uptime_d</li>
<li>dml_active=(com_select_d+com_insert_d+com_update_d+com_delete_d)/uptime_d</li>
</ul>
</li>
<li>各种 buffer、cache 的利用率、命中率<ul>
<li>innodb_buffer_pool_wait_free&gt;0 说明 innodb_buffer 不够用,有 wait、wait_free 发生，都要关注下</li>
<li>innodb_row_lock_current_waits 当前行锁的个数</li>
<li>slow_queries 慢查询的次数</li>
<li>table_locks_immediate 表锁的次数</li>
<li>table_locks_waited 表锁等待的次数</li>
</ul>
</li>
</ol>
</li>
<li><p>show processlist</p>
</li>
<li><p>show engine innodb status<br>主要看锁，事务，等待</p>
</li>
<li><p>pt-ioprofile<br>可以查看哪个表在频繁的读写</p>
</li>
</ul>
<h3 id="频繁度分析"><a href="#频繁度分析" class="headerlink" title="频繁度分析"></a>频繁度分析</h3><ul>
<li>写频繁度<ul>
<li>如果i/o压力高，优先分析写入频繁度</li>
<li>Mysqlbinlog 输出最新binlog文件，编写脚本拆分</li>
<li>最多写入的数据表是哪个</li>
<li>最多写入的数据SQL是什么</li>
<li>是否存在基于同一主键的数据内容高频重复写入？<ul>
<li>涉及架构优化部分，参见架构优化-缓存异步更新</li>
</ul>
</li>
</ul>
</li>
<li>读取频繁度<ul>
<li>如果cpu资源较高，而i/o压力不高，优先分析读取频繁度</li>
<li>程序中在封装的db类增加抽样日志即可，抽样比例酌情考虑，以不显著影响系统负载压力为底线。</li>
<li>最多读取的数据表是哪个</li>
<li>最多读取的数据SQL是什么<ul>
<li>该SQL进行explain 和set profiling判定</li>
<li>注意判定时需要避免query cache影响<ul>
<li>比如，在这个SQL末尾增加一个条件子句 and 1=1 就可以避免从query cache中获取数据，而得到真实的执行状态分析。</li>
</ul>
</li>
</ul>
</li>
<li>是否存在同一个查询短期内频繁出现的情况<ul>
<li>涉及前端缓存优化</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="制定方案"><a href="#制定方案" class="headerlink" title="制定方案"></a>制定方案</h2><p>抓大放小，解决显著问题</p>
<ul>
<li>不苛求解决所有优化问题，但是应以保证线上服务稳定可靠为目标。</li>
<li>解决与评估要同时进行，新的策略或解决方案务必经过评估后上线。</li>
</ul>
<h2 id="测试方案"><a href="#测试方案" class="headerlink" title="测试方案"></a>测试方案</h2><p>确认优化方案的覆盖范围，不要为了解决1%的问题而忽略了99%的问题，并且不能带来新的问题（索引滥用，太多索引，导致 dml 效率降低）而且最好再测试环境验证通过后再上线</p>
<h2 id="实施方案"><a href="#实施方案" class="headerlink" title="实施方案"></a>实施方案</h2><h2 id="回顾反馈"><a href="#回顾反馈" class="headerlink" title="回顾反馈"></a>回顾反馈</h2><h1 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h1><h2 id="服务器出现too-many-connections-阻塞"><a href="#服务器出现too-many-connections-阻塞" class="headerlink" title="服务器出现too many connections 阻塞"></a>服务器出现too many connections 阻塞</h2><p>入手点：</p>
<ul>
<li>查看服务器状态，cpu占用，内存占用，硬盘占用，硬盘i/o压力</li>
<li>查看网络流量状态，mysql与应用服务器的输入输出状况</li>
<li>通过Show processlist查看当前运行清单</li>
<li>注意事项，日常应用程序连接数据库不要使用root账户，保证故障时可以通过root 进入数据库查看 show processlist。</li>
</ul>
<p>状态分析：</p>
<ul>
<li>参见如上执行状态清单，根据连接状态的分布去确定原因。</li>
</ul>
<p>紧急恢复</p>
<ul>
<li>在确定故障原因后，应通过kill掉阻塞进程的方式 立即恢复数据库。</li>
</ul>
<p>善后处理：以下针对常见问题简单解读</p>
<ul>
<li>Sleep 连接过多导致，应用端及时释放连接，排查关联因素。</li>
<li>Locked连接过多，如源于myisam表级锁，更innodb引擎;如源于更新操作使用了不恰当的索引或未使用索引，改写更新操作SQL或建立恰当索引。</li>
<li>Sending data连接过多，用影响结果集的思路优化SQL查询，优化表索引结构。</li>
<li>Free items连接过多，i/o压力过大 或硬盘故障</li>
<li>Waiting for net , writing to net 连接过多， mysql与应用服务器连接阻塞。</li>
<li>其他仍参见如上执行状态清单所示分析。</li>
<li>如涉及不十分严格安全要求的数据内容，可用定期脚本跟踪请求进程，并kill掉僵死进程。如数据安全要求较严格，则不能如此进行。</li>
</ul>
<h2 id="数据库负载过高，响应缓慢"><a href="#数据库负载过高，响应缓慢" class="headerlink" title="数据库负载过高，响应缓慢"></a>数据库负载过高，响应缓慢</h2><p><strong>入手点：</strong></p>
<ul>
<li>查看cpu状态，服务器负载构成</li>
</ul>
<p><strong>可能问题1：i/o占用过高</strong></p>
<ul>
<li>步骤1： 检查内存是否占用swap分区，排除因内存不足导致的i/o开销。</li>
<li>步骤2：通过iostat 指令分析i/o是否集中于数据库硬盘，是否是写入度较高。</li>
<li>步骤3：如果压力来自于写，使用mysqlbinlog 解开最新的binlog文件。</li>
<li>步骤4：编写日志分析脚本或grep指令，分析每秒写入频度和写入内容。<ul>
<li>写入频度不高，则说明i/o压力另有原因或数据库配置不合理。</li>
</ul>
</li>
<li>步骤5：编写日志分析脚本或grep 指令，分析写入的数据表构成，和写入的目标构成。</li>
<li>步骤6：编写日志分析脚本，分析是否存在同一主键的重复写入。 比如出现大量 update post set views=views+1 where tagid=的操作，假设在一段时间内出现了2万次，而其中不同的tagid有1万次，那么就是有50%的请求是重复update请求，有可以通过异步更新合并的空间。</li>
</ul>
<p>提示一下，以上所提及的日志分析脚本编写，正常情况下不应超过1个小时，而对系统负载分析所提供的数据支持价值是巨大的，对性能优化方案的选择是非常有意义的，如果您认为这项工作是繁冗而且复杂的工作，那么一定是在分析思路和目标把握上出现了偏差。</p>
<p><strong>可能问题2：i/o占用不高，CPU 占用过高</strong></p>
<ul>
<li>步骤1：查看慢查询日志</li>
<li>步骤2：不断刷新查看Show processlist清单，并把握可能频繁出现的处于Sending data状态的SQL。</li>
<li>步骤3：记录前端执行SQL<ul>
<li>于前端应用程序执行查询的封装对象内，设置随机采样，记录前端执行的SQL，保证有一定的样本规模，并且不会带来前端i/o负载的激增。</li>
<li>基于采样率和记录频率，获得每秒读请求次数数据指标。</li>
<li>编写日志分析脚本，分析采样的SQL构成，所操作的数据表，所操作的主键。</li>
<li>对频繁重复读取的SQL(完全一致的SQL)进行判定，是否数据存在频繁变动，是否需要实时展现最新数据，如有可能，缓存化，并预估缓存命中率。</li>
<li>对频繁读取但不重复的(SQL结构一致，但条件中的数据不一致)SQL进行判定，是否索引足够优化，影响结果集与输出结果是否足够接近。</li>
</ul>
</li>
<li>步骤4：将导致慢查询的SQL或频繁出现于show processlist状态的SQL，或采样记录的频繁度SQL进行分析，按照影响结果集的思路和索引理解来优化。</li>
<li>步骤5：对如上难以界定问题的SQL进行 set profiling 分析。</li>
<li>步骤6：优化后分析继续采样跟踪分析。并跟踪比对结果。</li>
</ul>
<p><strong>善后处理</strong></p>
<ul>
<li>日常跟踪脚本，不断记录一些状态信息。保证每个时间节点都能回溯。</li>
<li>确保随时能了解服务器的请求频次，读写请求的分布。</li>
<li>记录一些未造成致命影响的隐患点，可暂不解决，但需要记录。</li>
<li>如确系服务器请求频次过高，可基于负载分布决定硬件扩容方案，比如i/o压力过高可考虑固态硬盘；内存占用swap可考虑增加内容容量等。用尽可能少的投入实现最好的负载支撑能力，而不是简单的买更多服务器。</li>
</ul>
<!--以下是脚注-->

            </div>
        
        <footer class="article-footer">
          <div style="float:left">
            
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mysql/">mysql</a>
    </div>

          </div>
          <div style="float:right">
            
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2-开发技能/数据库/Mysql/分析问题/">
            <time datetime="2017-11-17T02:15:00.000Z" itemprop="datePublished">2017-11-17</time>
        </a>
    </div>


          </div>
        </footer>
    </div>
</article>


    



    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>

</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
          Copyright © 2017 贺龙飞. Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" rel="external nofollow noopener noreferrer" target="_blank">wikitten</a>
          <p>
        本作品采用<a rel="external nofollow noopener noreferrer" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
        </p>
        <p style="display:none">
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1267343220'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1267343220%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
        </p>
        </div>
    </div>
</footer>

        

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
