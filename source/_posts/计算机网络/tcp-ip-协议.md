---
layout: "post"
title: "TCP/IP 协议"
date: "2017-11-11 11:00"
toc: true
tags:
top: 9998
---

指代整个协议族；之所以叫`TCP/IP协议`，是因为`TCP`、`IP`是核心的协议。

# 传输层
## TCP 协议
### 定义
> TCP（Transmission Control Protocol 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC 793定义

### 数据传输
![tcp-transfer](/images/2017/11/tcp-transfer.png)

#### 三次握手

**WHY**

> **为什么要三次握手？**
为了防止已失效的客户端连接请求突然又传送到了服务端，若没有客户端确认，则会占用服务端的资源。

**HOW**

![tcp 三次握手](/images/2017/11/tcp-三次握手.png)

| 客户端          | 传输 | 服务端          |
| --------------- | ---- | --------------- |
| SYN(x)          | ->   | SYN(x)          |
| SYN(y)-ACK(x+1) | <-   | SYN(y)+ACK(x+1) |
| ACK(y+1)        | ->   | ACK(Y+1)        |

> 必须是客户端发起的SYN

SYN: 同步序列编号（Synchronize Sequence Numbers）
ACK: 确认编号（Acknowledgement Number）

#### 四次挥手

**WHY**

> **为什么要四次挥手？**
全双工通信，所以必须双方都确认 FIN 才可以关闭连接

**HOW**

![tcp-四次挥手](/images/2017/11/tcp-四次挥手.png)

| 客户端              | 传输 | 服务端                 |
|---------------------|------|------------------------|
| FIN(客户端传输完毕) | ->   | FIN                    |
| ACK                 | <-   | ACK（先确认）          |
| FIN                 | <-   | FIN （服务端传输完毕） |
| ACK                 | ->   | ACK                    |

> 客户端、服务端都可以发起 FIN

FIN: 数据传输完毕 (Finsh)

### 包头结构

| 名称      | 长度       |
|-----------|------------|
| 源端口    | 16位       |
| 目标端口  | 16位       |
| 序列号    | 32位       |
| 回应序号  | 32位       |
| TCP头长度 | 4位        |
| reserved  | 6位        |
| 控制代码  | 6位        |
| 窗口大小  | 16位       |
| 偏移量    | 16位       |
| 校验和    | 16位       |
| 选项      | 32位(可选) |

> TCP包头的最小长度，为20字节。


## UDP 协议
### 定义
一种无连接的传输层协议；可靠性通过「应用层」保证。

### 数据传输

不提供数据包分组、组装和不能对数据包进行排序

### 包头结构

| 名称     | 长度 |
| -------- | ---- |
| 源端口   | 16位 |
| 目的端口 | 16位 |
| 长度     | 16位 |
| 校验和   | 16位 |

> UDP包头只有8个字节

### 常见的协议
DNS

### 应用场景：
1. 面向数据报方式
2. 网络数据大多为短消息
3. 拥有大量Client
4. 对数据安全性无特殊要求
5. 网络负担非常重，但对响应速度要求高

## TCP vs UDP

| -        | TCP                   | UDP                            |
| -------- | --------------------- | ------------------------------ |
| 可靠性   | 可靠（面向连接）      | 不可靠（无连接）               |
| 有序性   | 有序                  | 无序                           |
| 占用资源 | 多                    | 少                             |
| 程序结构 | 复杂                  | 简单                           |
| 数据模式 | 数据流[^1]（字节流） | 数据报文[^2]                  |
| 通信模式 | 点对点                | 一对一，一对多，多对一，多对多 |
| 首部开销 | 20字节                | 8字节                          |
| 通信信道 | 全双工                | 不可靠信道                     |

[^1]: 可以合并多个请求数据(放在缓冲区中)，一次/多次读取完

[^2]: 发送几次请求，就需要接收几次；一次只能读取一个完整的报文


# 网络层
## IP 协议

### 作用
IP协议是`TCP/IP协议簇`中的核心协议，也是`TCP/IP`的载体。
所有的`TCP，UDP，ICMP及IGMP数据`都以 **IP数据报** 格式传输。
IP提供**不可靠**的，**无连接**的数据传送服务；如果**发生某种错误，IP会丢失该数据，然后发送ICMP消息给信源端**

### IP数据报

![ip1](/images/2017/11/ip1.png)
![ip2](/images/2017/11/ip2.png)

### IP路由选择

#### 局域网

经过**ARP协议**将目的主机的IP地址解析为MAC地址

#### 非局域网

主机通过IP数据报连接目的主机时，按照如下步骤搜索:

1. 搜索路由表，优先搜索**匹配主机**，如果能找到和IP地址完全一致的目标主机，则将该包发向目标主机
2. 搜索路由表，如果匹配主机失败，则匹配**同子网的路由器**，这需要子网掩码的协助。如果找到路由器，则将该包发向路由器。
3. 搜索路由表，如果匹配同子网路由器失败，则匹配**同网号路由器**，如果找到路由器，则将该包发向路由器。
4. 搜索路由表，如果以上都失败了，就**搜索默认路由**，如果默认路由存在，则发包
5. 如果都失败了，就丢掉这个包。

### 如何查看路由表

![ip-router](/images/2017/11/ip-router.png)

# 参考资料

- [维基百科-TCP](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)
- [百科-TCP](https://baike.baidu.com/item/TCP/33012?fr=aladdin)
- [CDSN-TCP](http://network.51cto.com/art/201411/456783.htm)
- [IP协议-CSDN](http://blog.csdn.net/houdong/article/details/1505798)
- [IP协议-百度经验](https://jingyan.baidu.com/article/36d6ed1f56b9fe1bce48837f.html)

<!--以下是脚注-->
